name: Sync OCI Artifacts

on:
  workflow_dispatch:
    inputs:
      artifacts:
        description: 'JSON array of artifacts to sync (e.g., [{"source": "oci://ghcr.io/bank-vaults/helm-charts/vault-operator:1.23.0", "destination": "docker.io/khuedoan/helm-vault-operator:1.23.0"}])'
        required: true
        type: string
      source_registry:
        description: 'Source registry (e.g., ghcr.io)'
        required: false
        type: string
        default: ''
      source_username:
        description: 'Source registry username'
        required: false
        type: string
        default: ''
      destination_registry:
        description: 'Destination registry (e.g., docker.io)'
        required: false
        type: string
        default: 'docker.io'
      destination_username:
        description: 'Destination registry username'
        required: false
        type: string
        default: ''

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Install Skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Login to source registry
        if: ${{ inputs.source_username != '' }}
        env:
          SOURCE_REGISTRY: ${{ inputs.source_registry }}
          SOURCE_USERNAME: ${{ inputs.source_username }}
          SOURCE_PASSWORD: ${{ secrets.SOURCE_REGISTRY_PASSWORD }}
        run: |
          if [ -n "$SOURCE_REGISTRY" ] && [ -n "$SOURCE_USERNAME" ] && [ -n "$SOURCE_PASSWORD" ]; then
            echo "Logging in to source registry: $SOURCE_REGISTRY"
            skopeo login "$SOURCE_REGISTRY" --username "$SOURCE_USERNAME" --password-stdin <<< "$SOURCE_PASSWORD"
          fi

      - name: Login to destination registry
        if: ${{ inputs.destination_username != '' }}
        env:
          DEST_REGISTRY: ${{ inputs.destination_registry }}
          DEST_USERNAME: ${{ inputs.destination_username }}
          DEST_PASSWORD: ${{ secrets.DESTINATION_REGISTRY_PASSWORD }}
        run: |
          if [ -n "$DEST_REGISTRY" ] && [ -n "$DEST_USERNAME" ] && [ -n "$DEST_PASSWORD" ]; then
            echo "Logging in to destination registry: $DEST_REGISTRY"
            skopeo login "$DEST_REGISTRY" --username "$DEST_USERNAME" --password-stdin <<< "$DEST_PASSWORD"
          fi

      - name: Sync OCI artifacts
        env:
          ARTIFACTS: ${{ inputs.artifacts }}
        run: |
          echo "Syncing artifacts..."
          echo "$ARTIFACTS" | jq -c '.[]' | while read -r artifact; do
            SOURCE=$(echo "$artifact" | jq -r '.source')
            DESTINATION=$(echo "$artifact" | jq -r '.destination')
            
            echo "Syncing: $SOURCE -> $DESTINATION"
            
            # Copy the artifact using skopeo
            skopeo copy "$SOURCE" "docker://$DESTINATION" --all
            
            echo "Successfully synced: $SOURCE -> $DESTINATION"
          done
          
          echo "All artifacts synced successfully!"
