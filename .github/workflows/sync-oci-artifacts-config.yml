name: Sync OCI Artifacts from Config

on:
  workflow_dispatch:
    inputs:
      config_file:
        description: 'Path to the artifacts config file (JSON format)'
        required: false
        type: string
        default: '.github/sync-artifacts.json'
  push:
    paths:
      - '.github/sync-artifacts.json'
      - '.github/workflows/sync-oci-artifacts-config.yml'
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Login to GitHub Container Registry (source)
        env:
          GHCR_TOKEN: ${{ secrets.SOURCE_GHCR_TOKEN }}
          GHCR_USERNAME: ${{ github.repository_owner }}
        run: |
          if [ -n "$GHCR_TOKEN" ]; then
            echo "Logging in to ghcr.io"
            echo "$GHCR_TOKEN" | skopeo login ghcr.io --username "$GHCR_USERNAME" --password-stdin
          fi

      - name: Login to Docker Hub (destination)
        env:
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          if [ -n "$DOCKERHUB_TOKEN" ] && [ -n "$DOCKERHUB_USERNAME" ]; then
            echo "Logging in to docker.io"
            echo "$DOCKERHUB_TOKEN" | skopeo login docker.io --username "$DOCKERHUB_USERNAME" --password-stdin
          fi

      - name: Login to additional source registry
        env:
          SOURCE_REGISTRY: ${{ secrets.SOURCE_REGISTRY }}
          SOURCE_USERNAME: ${{ secrets.SOURCE_USERNAME }}
          SOURCE_PASSWORD: ${{ secrets.SOURCE_REGISTRY_PASSWORD }}
        run: |
          if [ -n "$SOURCE_REGISTRY" ] && [ -n "$SOURCE_USERNAME" ] && [ -n "$SOURCE_PASSWORD" ]; then
            echo "Logging in to source registry: $SOURCE_REGISTRY"
            echo "$SOURCE_PASSWORD" | skopeo login "$SOURCE_REGISTRY" --username "$SOURCE_USERNAME" --password-stdin
          fi

      - name: Login to additional destination registry
        env:
          DEST_REGISTRY: ${{ secrets.DESTINATION_REGISTRY }}
          DEST_USERNAME: ${{ secrets.DESTINATION_USERNAME }}
          DEST_PASSWORD: ${{ secrets.DESTINATION_REGISTRY_PASSWORD }}
        run: |
          if [ -n "$DEST_REGISTRY" ] && [ -n "$DEST_USERNAME" ] && [ -n "$DEST_PASSWORD" ]; then
            echo "Logging in to destination registry: $DEST_REGISTRY"
            echo "$DEST_PASSWORD" | skopeo login "$DEST_REGISTRY" --username "$DEST_USERNAME" --password-stdin
          fi

      - name: Sync OCI artifacts from config
        env:
          CONFIG_FILE: ${{ inputs.config_file || '.github/sync-artifacts.json' }}
        run: |
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "Config file not found: $CONFIG_FILE"
            echo "Creating example config file..."
            exit 1
          fi

          echo "Reading artifacts from: $CONFIG_FILE"
          cat "$CONFIG_FILE"
          echo ""
          
          echo "Syncing artifacts..."
          jq -c '.artifacts[]' "$CONFIG_FILE" | while read -r artifact; do
            SOURCE=$(echo "$artifact" | jq -r '.source')
            DESTINATION=$(echo "$artifact" | jq -r '.destination')
            ENABLED=$(echo "$artifact" | jq -r '.enabled // true')
            
            if [ "$ENABLED" = "false" ]; then
              echo "Skipping disabled artifact: $SOURCE"
              continue
            fi
            
            echo "----------------------------------------"
            echo "Syncing: $SOURCE"
            echo "     to: $DESTINATION"
            
            # Copy the artifact using skopeo with all platform variants
            if skopeo copy "$SOURCE" "$DESTINATION" --all --retry-times 3; then
              echo "✓ Successfully synced"
            else
              echo "✗ Failed to sync: $SOURCE -> $DESTINATION"
              exit 1
            fi
          done
          
          echo "----------------------------------------"
          echo "All artifacts synced successfully!"
